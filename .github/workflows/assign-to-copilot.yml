name: Assign issue to Copilot (coding agent)

on:
  issues:
    types: [labeled]

permissions:
  issues: write
  contents: read

jobs:
  assign:
    # Troque "copilot" pela label que você quiser (ex: ai-fix)
    if: github.event.label.name == 'copilot'
    runs-on: ubuntu-latest

    steps:
      - name: Assign to Copilot coding agent
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = context.payload.issue.number;

            // Ajuste aqui se quiser base_branch diferente
            const base_branch = "main";

            await github.request('POST /repos/{owner}/{repo}/issues/{issue_number}/assignees', {
              owner,
              repo,
              issue_number,
              assignees: ["copilot-swe-agent[bot]"],
              agent_assignment: {
                target_repo: `${owner}/${repo}`,
                base_branch,
                custom_instructions: "",
                custom_agent: "",
                model: ""
              }
            });

      # (Opcional) Evita re-trigger se alguém reaplicar label
      - name: Remove label copilot (optional)
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = context.payload.issue.number;

            try {
              await github.request('DELETE /repos/{owner}/{repo}/issues/{issue_number}/labels/{name}', {
                owner, repo, issue_number, name: "copilot"
              });
            } catch (e) {
              core.info(`Could not remove label: ${e.message}`);
            }
